#!/usr/bin/env bash
set -euo pipefail

# 管理员配置（通过环境变量设置）
ADMIN_USER="${ADMIN_USER:-admin}"
ADMIN_PASS="${ADMIN_PASS:-admin123}"

# 1. 拉取最新代码
echo "==> 拉取最新代码..."
git pull origin main || true

# 2. 前端打包（如有 web/ 目录）
if [[ -d "web" ]]; then
    echo "==> 构建前端..."
    cd web
    npm install
    npm run build
    cd ..
fi

# 3. 后端编译
echo "==> 编译后端..."
mvn clean package -DskipTests

# 4. 停止旧进程
echo "==> 停止旧进程..."
pkill -f "java.*jar" || true
sleep 2

# 5. 启动新进程
echo "==> 启动服务..."
ADMIN_USER="$ADMIN_USER" ADMIN_PASS="$ADMIN_PASS" \
    nohup java -jar target/*.jar > server.log 2>&1 &

echo "==> 服务已启动"
echo "    管理员账号: $ADMIN_USER"
echo "    日志文件: server.log"
